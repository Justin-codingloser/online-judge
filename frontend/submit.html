<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>é¡Œç›®æäº¤ | Online Judge</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-800 min-h-screen">

    <!-- å°è¦½åˆ— -->
    <nav class="bg-blue-600 text-white px-6 py-3 flex justify-between items-center shadow-md">
        <div class="text-xl font-bold">
            <a href="problems.html" class="hover:underline">ğŸ Online Judge</a>
        </div>
        <div class="space-x-4">
            <a href="problems.html" class="hover:underline">é¡Œç›®ç¸½è¦½</a>
            <a href="submission-history.html" class="hover:underline">ç´€éŒ„</a>
            <a href="creat-problem.html" class="hover:underline" id="adminLink1">å‡ºé¡Œ</a>
            <a href="manage-problems.html" class="hover:underline" id="adminLink2">é¡Œç›®ç®¡ç†</a>
        </div>
        <div class="flex items-center space-x-4">
            <span id="currentUser" class="font-medium">ï¼ˆå°šæœªç™»å…¥ï¼‰</span>
            <button onclick="logout()" class="bg-white text-blue-600 px-3 py-1 rounded hover:bg-blue-100">ç™»å‡º</button>
        </div>
    </nav>

    <!-- ä¸»å€å¡Š -->
    <main class="max-w-3xl mx-auto p-6 bg-white mt-6 rounded shadow">
        <h1 class="text-2xl font-bold mb-4" id="problemTitle">ğŸ“˜ é¡Œç›®æ¨™é¡Œè¼‰å…¥ä¸­...</h1>
        <p id="problemDescription" class="mb-4 whitespace-pre-line text-gray-700">ğŸ“„ é¡Œç›®å…§å®¹è¼‰å…¥ä¸­...</p>

        <div class="mb-4">
            <div><strong>è¼¸å…¥èªªæ˜ï¼š</strong><span id="problemInput"></span></div>
            <div><strong>è¼¸å‡ºèªªæ˜ï¼š</strong><span id="problemOutput"></span></div>
            <div><strong>ç¯„ä¾‹è¼¸å…¥ï¼š</strong><pre id="problemSampleInput" class="bg-gray-100 p-2 rounded"></pre></div>
            <div><strong>ç¯„ä¾‹è¼¸å‡ºï¼š</strong><pre id="problemSampleOutput" class="bg-gray-100 p-2 rounded"></pre></div>
        </div>

        <form id="submitForm" class="space-y-4">
            <div>
                <label class="block mb-1 font-medium">ä½ çš„ç¨‹å¼ç¢¼ï¼š</label>
                <textarea id="code" rows="10" required class="w-full border rounded px-3 py-2 focus:outline-none focus:ring focus:border-blue-400"></textarea>
            </div>
            <button type="submit" class="w-full bg-green-600 text-white py-2 rounded hover:bg-green-700">
                ğŸš€ æäº¤ç¨‹å¼ç¢¼
            </button>
            <p id="resultMsg" class="text-center mt-2 text-sm"></p>
        </form>
    </main>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const problemId = urlParams.get("id");

        const user = JSON.parse(localStorage.getItem("user"));
        if (!user || !user.username) {
            alert("è«‹å…ˆç™»å…¥ï¼");
            window.location.href = "login.html";
        }

        // é¡¯ç¤ºç™»å…¥å¸³è™Ÿ
        document.getElementById("currentUser").innerText = user.username;

        // åªæœ‰ admin æ‰é¡¯ç¤ºã€Œå‡ºé¡Œã€é€£çµ
        if (!user.isAdmin) {
            document.getElementById("adminLink1").style.display = "none";
            document.getElementById("adminLink2").style.display = "none";
        }

        // é¡Œç›®è³‡æ–™è¼‰å…¥
        async function loadProblem() {
            const res = await fetch(`https://online-judge-ospk.onrender.com/api/problems/${problemId}`);
            const data = await res.json();
            document.getElementById("problemTitle").innerText = data.title;
            document.getElementById("problemDescription").innerText = data.description;
            document.getElementById("problemInput").innerText = data.input || "";
            document.getElementById("problemOutput").innerText = data.output || "";
            document.getElementById("problemSampleInput").innerText = data.sampleInput || "";
            document.getElementById("problemSampleOutput").innerText = data.sampleOutput || "";
        }

        loadProblem();

        // ç™»å‡ºåŠŸèƒ½
        function logout() {
            localStorage.removeItem("user");
            alert("ä½ å·²ç™»å‡ºï¼");
            window.location.href = "login.html";
        }

        // æäº¤åŠŸèƒ½
        document.getElementById("submitForm").addEventListener("submit", async (e) => {
            e.preventDefault();

            const code = document.getElementById("code").value;
            const resultMsg = document.getElementById("resultMsg");

            const res = await fetch(`https://online-judge-ospk.onrender.com/api/submit/${problemId}`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    userId: user._id,
                    username: user.username,
                    code
                })
            });

            let result;
            try {
                result = await res.json();
            } catch {
                result = {};
            }

            if (res.ok) {
                resultMsg.innerText = "âœ… æäº¤æˆåŠŸï¼";
                resultMsg.className = "text-green-600 text-center mt-2 text-sm";
                window.location.href = "submission-history.html";
            } else {
                resultMsg.innerText = "âŒ æäº¤å¤±æ•—ï¼š" + (result.error || "è«‹å†è©¦ä¸€æ¬¡");
                resultMsg.className = "text-red-600 text-center mt-2 text-sm";
            }
        });
    </script>
</body>
</html>
