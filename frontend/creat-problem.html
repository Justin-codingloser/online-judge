<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>æ–°å¢é¡Œç›®</title>
</head>
<body>
    <h1>ğŸ› ï¸ æ–°å¢é¡Œç›®</h1>
    <p>
        ğŸ‘¤ ç›®å‰ç™»å…¥å¸³è™Ÿï¼š<span id="currentUser">ï¼ˆå°šæœªç™»å…¥ï¼‰</span>
        <button onclick="logout()">ğŸ”“ ç™»å‡º</button>
    </p>

    <div id="adminOnly">
        <form id="problemForm">
            <label>æ¨™é¡Œï¼š<br><input type="text" id="title" required></label><br><br>
            <label>æè¿°ï¼š<br><textarea id="description" rows="5" cols="60"></textarea></label><br><br>
            <label>è¼¸å…¥èªªæ˜ï¼š<br><input type="text" id="input" required></label><br><br>
            <label>è¼¸å‡ºèªªæ˜ï¼š<br><input type="text" id="output" required></label><br><br>
            <label>ç¯„ä¾‹è¼¸å…¥ï¼š<br><textarea id="sampleInput" rows="2" cols="60"></textarea></label><br><br>
            <label>ç¯„ä¾‹è¼¸å‡ºï¼š<br><textarea id="sampleOutput" rows="2" cols="60"></textarea></label><br><br>
            <label>æ¸¬è³‡ï¼ˆJSON æ ¼å¼ï¼‰ï¼š<br>
                <textarea id="testcases" rows="6" cols="60">[{"input":"1 2","output":"3"},{"input":"3 4","output":"7"}]</textarea>
            </label><br><br>

            <button type="submit">ğŸ“¤ ä¸Šå‚³é¡Œç›®</button>
        </form>
    </div>

    <p id="message"></p>

    <hr>
    <h2>ğŸ“˜ é¡Œç›®æ¸…å–®</h2>
    <ul id="problemList"></ul>

    <script>
        // âœ… ç™»å…¥é©—è­‰
        const user = JSON.parse(localStorage.getItem("user"));
        if (!user || !user.username) {
            alert("è«‹å…ˆç™»å…¥ï¼");
            window.location.href = "login.html";
        }
        document.getElementById("currentUser").innerText = user.username;

        // âœ… æ¬Šé™æª¢æŸ¥
        if (user.isAdmin!== true) {
            document.getElementById("adminOnly").style.display = "none";
            document.getElementById("message").innerText = "âš ï¸ ä½ æ²’æœ‰å‡ºé¡Œæ¬Šé™ï¼Œåªèƒ½ç€è¦½é¡Œç›®";
        }

        // âœ… ç™»å‡ºåŠŸèƒ½
        function logout() {
            localStorage.removeItem("user");
            alert("ä½ å·²ç™»å‡ºï¼");
            window.location.href = "login.html";
        }

        // âœ… é¡Œç›®ä¸Šå‚³
        document.getElementById("problemForm")?.addEventListener("submit", async function (e) {
            e.preventDefault();

            const problem = {
                title: document.getElementById("title").value,
                description: document.getElementById("description").value,
                input: document.getElementById("input").value,
                output: document.getElementById("output").value,
                sampleInput: document.getElementById("sampleInput").value,
                sampleOutput: document.getElementById("sampleOutput").value,
                testcases: JSON.parse(document.getElementById("testcases").value),
                createdBy: user._id
            };

            const res = await fetch("https://online-judge-ospk.onrender.com/api/problems/create", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(problem)
            });

            if (res.ok) {
                document.getElementById("message").innerText = "âœ… é¡Œç›®æ–°å¢æˆåŠŸï¼";
                document.getElementById("problemForm").reset();
                loadProblems(); // æ›´æ–°åˆ—è¡¨
            } else {
                const err = await res.text();
                document.getElementById("message").innerText = "âŒ ç™¼ç”ŸéŒ¯èª¤ï¼š" + err;
            }
        });

        // âœ… é¡¯ç¤ºç›®å‰æ‰€æœ‰é¡Œç›®
        async function loadProblems() {
            const res = await fetch("https://online-judge-ospk.onrender.com/api/problems/list");
            const problems = await res.json();

            const list = document.getElementById("problemList");
            list.innerHTML = ""; // æ¸…ç©º
            problems.forEach(p => {
                const li = document.createElement("li");
                const a = document.createElement("a");
                a.href = `submit.html?id=${p._id}`;
                a.innerText = p.title;
                li.appendChild(a);
                list.appendChild(li);
            });
        }

        loadProblems();
    </script>
</body>
</html>
