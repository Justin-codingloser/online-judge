<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>ç·¨è¼¯é¡Œç›®</title>
</head>
<body>
    <h1>âœï¸ ç·¨è¼¯é¡Œç›®</h1>
    <p>
        ğŸ‘¤ ç™»å…¥å¸³è™Ÿï¼š<span id="currentUser">ï¼ˆå°šæœªç™»å…¥ï¼‰</span>
        <button onclick="logout()">ğŸ”“ ç™»å‡º</button>
    </p>

    <form id="editForm">
        <label>æ¨™é¡Œï¼š<br><input type="text" id="title" required></label><br><br>
        <label>æè¿°ï¼š<br><textarea id="description" rows="5" cols="60"></textarea></label><br><br>
        <label>è¼¸å…¥èªªæ˜ï¼š<br><input type="text" id="input" required></label><br><br>
        <label>è¼¸å‡ºèªªæ˜ï¼š<br><input type="text" id="output" required></label><br><br>
        <label>ç¯„ä¾‹è¼¸å…¥ï¼š<br><textarea id="sampleInput" rows="2" cols="60"></textarea></label><br><br>
        <label>ç¯„ä¾‹è¼¸å‡ºï¼š<br><textarea id="sampleOutput" rows="2" cols="60"></textarea></label><br><br>
        <label>æ¸¬è³‡ï¼ˆJSON æ ¼å¼ï¼‰ï¼š<br>
            <textarea id="testcases" rows="6" cols="60"></textarea>
        </label><br><br>

        <button type="submit">ğŸ’¾ å„²å­˜ä¿®æ”¹</button>
    </form>

    <p id="message"></p>

    <script>
        const user = JSON.parse(localStorage.getItem("user"));
        if (!user || !user.username) {
            alert("è«‹å…ˆç™»å…¥ï¼");
            window.location.href = "login.html";
        }

        document.getElementById("currentUser").innerText = user.username;

        function logout() {
            localStorage.removeItem("user");
            alert("ä½ å·²ç™»å‡ºï¼");
            window.location.href = "login.html";
        }

        const urlParams = new URLSearchParams(window.location.search);
        const problemId = urlParams.get("id");

        // è¼‰å…¥é¡Œç›®å…§å®¹å¡«å…¥è¡¨å–®
        async function loadProblem() {
            const res = await fetch(`http://localhost:3000/api/problems/${problemId}`);
            const problem = await res.json();

            document.getElementById("title").value = problem.title;
            document.getElementById("description").value = problem.description;
            document.getElementById("input").value = problem.input;
            document.getElementById("output").value = problem.output;
            document.getElementById("sampleInput").value = problem.sampleInput;
            document.getElementById("sampleOutput").value = problem.sampleOutput;
            document.getElementById("testcases").value = JSON.stringify(problem.testcases, null, 2);
        }

        // é€å‡ºä¿®æ”¹
        document.getElementById("editForm").addEventListener("submit", async function (e) {
            e.preventDefault();

            const updated = {
                title: document.getElementById("title").value,
                description: document.getElementById("description").value,
                input: document.getElementById("input").value,
                output: document.getElementById("output").value,
                sampleInput: document.getElementById("sampleInput").value,
                sampleOutput: document.getElementById("sampleOutput").value,
                testcases: JSON.parse(document.getElementById("testcases").value)
            };

            const res = await fetch(`https://online-judge-ospk.onrender.com/api/problems/${problemId}`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(updated)
            });

            if (res.ok) {
                document.getElementById("message").innerText = "âœ… ä¿®æ”¹æˆåŠŸ";
            } else {
                const err = await res.text();
                document.getElementById("message").innerText = "âŒ ä¿®æ”¹å¤±æ•—ï¼š" + err;
            }
        });

        loadProblem();
    </script>
</body>
</html>
